# Amazon Bedrock のガードレールを作成してみよう

* このワークでは、Amazon Bedrock のガードレールを作成します。
* ガードレールででブロックする内容は下記です。
    - 有害な入出力のブロック
    - プロンプト攻撃
    - 医療に関するトピックの拒否
* 作成したガードレールは、AWS マネジメントコンソールのテスト機能から動作確認を行います。

![概要](images/agent.png)

---
## 準備

* インストラクターが指定した環境で AWS マネジメントコンソールにサインインして下さい。
    - **このワークの環境は、ワークを実施する時間帯のみ使用可能です。**
* AWS マネジメントコンソールで、**指定されたリージョン**を選択した状態にしてください。
* ご自分に割り当てられた **2桁の番号**を覚えておいてください。

---
## 基盤モデルのアクセスの有効化

1. AWS マネジメントコンソールのページ上部の **検索**で `bedrock` と入力して **Amazon Bedrock** のメニューを選択します。
1. ページ左側で **設定および学習** の **モデルアクセス** を選択します。
1. **特定のモデルを有効にする** を選択します。
    - もしくは **モデルアクセスを変更** を選択します。
1. 下記のモデルのチェックボックスをチェックします。（すでにチェックされている場合はエージェントの作成手順に進んでください）
    - **Amazon** の **Nova Lite**
1. **次へ**　を選択します。
1. **送信**　を選択します。

---
## Amazon Bedrock ガードレールの作成

### ガードレールの詳細

1. ページ左側で **構築** の **ガードレール** を選択します。
1. **ガードレールを作成** を選択します。
1. **名前** に `anycompany-guardrail` と入力します。
1. **ブロックされたプロンプトのメッセージ表示** に下記を入力します。
    - `申しわけありませんが、そのお問い合わせには対応いたしかねます。`
1. **Cross-Region inference - optional** を展開表示します。
1. **Enable cross-Region inference for your guardrail** をチェックします。
1. **次へ** を選択します。

### コンテンツフィルターの設定

1. **有害カテゴリ** で **有害カテゴリのフィルターを有効にする** のトグルを有効化します。
1. ページを少し下にスクロールして、**プロンプト攻撃** で **プロンプト攻撃フィルターを有効にする** のトグルを有効化します。
1. **Content filters tier** で **Standard** を選択します。
    - **これはガードレールで日本語を扱う上で必要な設定です。**
1. **次へ** を選択します。

### 拒否トピックの設定

1. **拒否トピック** で **拒否されたトピックを追加** を選択します。
1. **名前** に `Medical-Query`
1. **定義** に以下を入力します。
    - ```
      医療や治療、体の健康、病気、症状に関しての問い合わせやアドバイスの要求
      ```
1. **Input** と **Output** の両方で **Enable** がチェックされ、**Block** になっていることを確認します。
1. **サンプルフレーズを追加** を展開表示します。
1. 以下３つを入力して、**フレーズを追加**　を選択します。
    - `咳が出るのですが、風邪でしょうか？`
    - `頭痛がするのですが、どんな薬を飲めばいいでしょうか？`
    - `膝が痛いのですが、治療する方法を教えてください。`

1. **Confirm** を選択します。
1. **Denied topics tier** で **Standard** を選択します。
    - **これはガードレールで日本語を扱う上で必要な設定です。**
1. **スキップして確認および作成** を選択します。

### ガードレールの作成とテスト

1. ページを下までスクロールして **ガードレールを作成** を選択します。
1. ページ右側の **テスト** で **モデルを選択** を選択して **Amazon** の **Nova Lite** を選択して、**適用**を選択します。
1. **プロンプト** で以下を入力して **実行** を選択します。
    - `熱が38度出て体がだるいのですが、どんな薬を飲めばいいですか？`
1. **ガードレールアクション** に **介入** と表示されることを確認します。
1. **最終応答** に、「**申しわけありませんが、そのお問い合わせには対応いたしかねます。**」 と表示されることを確認します。
1. **トレースを表示** を選択します。
1. **拒否トピック** の **Medical-Query** で **ブロック済** と表示されていることを確認します。
1. **ページ右側** の矢印が向き合っているアイコンをクリックして、トレース表示を閉じます。
1. **プロンプト** で以下を入力して **実行** を選択します。
    - `登山に興味があるのですが、日本で一番高い山は何ですか？`
1. **ガードレールアクション** に **アクションは実行されません** と表示されることを確認します。
1. **最終応答** に、問い合わせの回答が表示されていることを確認します。

1. **Amazon Bedrock のガードレールで、拒否トピックとして設定した内容の問い合わせをブロックできることを確認しました。**

---

### オプションタスク：作成したエージェントをコードから使用する
#### このタスクを実行する場合は今を実施して下さい。実施しない場合は、[リソースの削除](#リソースの削除) の手順を実行して下さい。

1. AWS マネジメントコンソールで、Bedrock のページを開き、ページ左側で **構築** の **エージェント** を選択します。

1. 作成したエージェントの名前のリンクを選択します。

1. **エージェントの概要** で、エージェントの **ID** をメモしておきます。

1. ページを下にスクロールして、**エイリアス** で **作成**　を選択します。

1. **エイリアス名** に **live** と入力します。

1. **バージョンを関連付ける** で **新しいバージョンを作成し、このエイリアスに関連付けます。** を選択します。

1. **エイリアスを作成** を選択します。

1. 作成したエイリアスの **エイリアス ID** をメモしておきます。

1. 講師が案内した開発環境へアクセスします。

1. ターミナルから以下のコマンドを実行して、AWS SDK for Python (boto3) を最新のものに更新します。
    - `ppip3 install boto3 --upgrade`

1. サンプルの Git リポジトリをクローンします。
    - `git clone https://github.com/tetsuo-nobe/dev_gen_ai_app_on_aws`

1. 以下のファイルを開き、コードを確認します。
    - **dev_gen_ai_app_on_aws/BedrockAgentExamples/BedrockAgentExampleSimpleVersion.py **
    - **環境に合わせて必要な部分を書き換えて保存します。**
        - ヒント：6行目のエージェントの ID、7行目のエイリアスの ID

1. ターミナルから以下のコマンドを実行して、コードを実行します。
    - ```
      cd ~/environment/dev_gen_ai_app_on_aws/BedrockAgentExamples/

      python3 BedrockAgentExampleSimpleVersion.py
      
      ```

1. **コードから Bedrock のエージェントを使用した問い合わせができたことを確認しました。**

---
# リソースの削除

1. 以降は、作成したリソースの削除処理を行います。
---
## エージェントの削除
1. ページ左側で **Build** の **エージェント** を選択します。
1. **エージェント** で **product-agent** をラジオボタンを選択して、**削除** を選択します。
1. 確認のダイアログで `delete` と入力して **Delete** を選択します。

## Lambda 関数の削除
1. AWS Lambda のページに切り替えます。
1. 編集した Lambda 関数のページで **アクション** - **関数の削除** を選択します。
1. 確認のダイアログで **削除** を選択します。

## CloudWatch ログの削除
1. Amazon CloudWatch のページに切り替えます。
1. **ログ** - **ロググループ** を選択します。
1. /aws/lambda/(関数名) のロググループのチェックボックスをチェックして、**アクション** - **ロググループの削除** を選択します。
1. 確認のダイアログで **削除** を選択します。
   
---
### お疲れさまでした。

* **このワークの環境は、ワークを実施する時間帯のみ使用可能です。**







